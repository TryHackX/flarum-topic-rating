(()=>{var t={550(t,a,n){"use strict";n.d(a,{A:()=>c});var r=n(781),i=n(924),s=n.n(i);const e=flarum.core.compat["common/components/LoadingIndicator"];var o=n.n(e),l=n(73),u=n.n(l),c=function(t){function a(){return t.apply(this,arguments)||this}(0,r.A)(a,t);var n=a.prototype;return n.oninit=function(a){t.prototype.oninit.call(this,a),this.discussion=this.attrs.discussion,this.ratings=[],this.loading=!0,this.moreResults=!1,this.offset=0,this.limit=10,this.total=0,this.pollInterval=null,this.lastPollTime=(new Date).toISOString(),this.loadRatings(),this.startPolling()},n.onremove=function(a){t.prototype.onremove.call(this,a),this.stopPolling()},n.className=function(){return"RatingsModal Modal--small"},n.title=function(){return u().translator.trans("tryhackx-topic-rating.forum.ratings_modal.title",{count:this.total})},n.content=function(){var t=this;return m("div",{className:"Modal-body"},m("div",{className:"RatingsModal-list",oncreate:this.setupScroll.bind(this)},this.ratings.map(function(a){return t.renderRatingItem(a)}),this.loading&&m(o(),null),!this.loading&&0===this.ratings.length&&m("div",{className:"RatingsModal-empty"},u().translator.trans("tryhackx-topic-rating.forum.ratings_modal.empty"))))},n.parseDate=function(t){if(!t)return null;var a=new Date(t);return isNaN(a.getTime())||a.getFullYear()<=1970?null:a},n.formatDateTime=function(t){var a=function(t){return String(t).padStart(2,"0")};return a(t.getDate())+"."+a(t.getMonth()+1)+"."+t.getFullYear()+" "+a(t.getHours())+":"+a(t.getMinutes())},n.renderRatingItem=function(t){var a=t.user,n=this.renderStarsDisplay(t.rating),r=this.parseDate(t.createdAt),i=this.parseDate(t.updatedAt),s=i&&r&&i.getTime()-r.getTime()>1e3,e=s?i:r,o=a?u().route("user",{username:a.slug||a.username}):null;return m("div",{className:"RatingsModal-item",key:t.id},m("div",{className:"RatingsModal-item-avatar"},a?m("a",{href:o},m("span",{className:"Avatar",style:a.avatarUrl?{"background-image":"url("+a.avatarUrl+")"}:{"background-color":a.color||"#888"}},a.avatarUrl?"":(a.displayName||a.username||"?").charAt(0).toUpperCase())):m("span",{className:"Avatar"},"?")),m("div",{className:"RatingsModal-item-info"},m("div",{className:"RatingsModal-item-top"},a?m("a",{href:o,className:"RatingsModal-item-username"},a.displayName||a.username):m("span",{className:"RatingsModal-item-username"},u().translator.trans("tryhackx-topic-rating.forum.ratings_modal.deleted_user")),e&&m("span",{className:"RatingsModal-item-date",title:this.formatDateTime(e)},s&&m("span",{className:"RatingsModal-item-date-prefix"},u().translator.trans("tryhackx-topic-rating.forum.ratings_modal.updated_prefix")),this.formatDateTime(e))),m("div",{className:"RatingsModal-item-stars"},n,m("span",{className:"RatingsModal-item-value"},(t.rating/2).toFixed(1)))))},n.renderStarsDisplay=function(t){for(var a=[],n=1;n<=5;n++){var r="StarDisplay";r+=t>=2*n?" StarDisplay--full":t>=2*(n-1)+1?" StarDisplay--half":" StarDisplay--empty",a.push(m("i",{className:"fas fa-star "+r,key:n}))}return m("span",{className:"StarDisplay-container"},a)},n.loadRatings=function(){var t=this;this.loading=!0;var a=this.discussion.id(),n=u().forum.attribute("apiUrl")+"/discussion-ratings?discussion_id="+a+"&page[offset]="+this.offset+"&page[limit]="+this.limit;fetch(n,{method:"GET",headers:{Accept:"application/json","X-CSRF-Token":u().session.csrfToken},credentials:"same-origin"}).then(function(t){if(!t.ok)throw new Error("HTTP "+t.status);return t.json()}).then(function(a){var n=t.parseRatings(a);t.ratings=0===t.offset?n:[].concat(t.ratings,n),t.total=a.meta?a.meta.total:t.ratings.length,t.moreResults=n.length>=t.limit,t.loading=!1,m.redraw()}).catch(function(a){console.error("RatingsModal load error:",a),t.loading=!1,m.redraw()})},n.parseRatings=function(t){var a=t.data||[],n=t.included||[],r={};return n.forEach(function(t){"users"===t.type&&(r[t.id]={id:t.id,slug:t.attributes.slug||t.attributes.username,username:t.attributes.username,displayName:t.attributes.displayName||t.attributes.username,avatarUrl:t.attributes.avatarUrl,color:t.attributes.color})}),a.map(function(t){var a=t.relationships&&t.relationships.user?t.relationships.user.data.id:null;return{id:t.id,rating:t.attributes.rating,createdAt:t.attributes.createdAt,updatedAt:t.attributes.updatedAt,user:a&&r[a]||null}})},n.setupScroll=function(t){var a=this,n=t.dom;n.addEventListener("scroll",function(){!a.loading&&a.moreResults&&n.scrollTop+n.clientHeight>=n.scrollHeight-50&&(a.offset+=a.limit,a.loadRatings())})},n.startPolling=function(){var t=this;this.pollInterval=setInterval(function(){t.pollForNewRatings()},5e3)},n.stopPolling=function(){this.pollInterval&&(clearInterval(this.pollInterval),this.pollInterval=null)},n.pollForNewRatings=function(){var t=this,a=u().forum.attribute("apiUrl")+"/discussion-ratings/poll?discussion_id="+this.discussion.id()+"&since="+encodeURIComponent(this.lastPollTime);fetch(a,{method:"GET",headers:{Accept:"application/json","X-CSRF-Token":u().session.csrfToken},credentials:"same-origin"}).then(function(t){return t.json()}).then(function(a){a.hasNewRatings&&(t.lastPollTime=(new Date).toISOString(),t.total=a.ratingCount,t.offset=0,t.loadRatings())})},a}(s())},924(t){"use strict";t.exports=flarum.core.compat["common/components/Modal"]},73(t){"use strict";t.exports=flarum.core.compat["forum/app"]},781(t,a,n){"use strict";function r(t,a){return r=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,a){return t.__proto__=a,t},r(t,a)}function i(t,a){t.prototype=Object.create(a.prototype),t.prototype.constructor=t,r(t,a)}n.d(a,{A:()=>i})}},a={};function n(r){var i=a[r];if(void 0!==i)return i.exports;var s=a[r]={exports:{}};return t[r](s,s.exports,n),s.exports}n.n=t=>{var a=t&&t.__esModule?()=>t.default:()=>t;return n.d(a,{a}),a},n.d=(t,a)=>{for(var r in a)n.o(a,r)&&!n.o(t,r)&&Object.defineProperty(t,r,{enumerable:!0,get:a[r]})},n.o=(t,a)=>Object.prototype.hasOwnProperty.call(t,a),(()=>{"use strict";var t=n(73),a=n.n(t);const r=flarum.core.compat["common/extend"],i=flarum.core.compat["forum/components/DiscussionHero"];var s=n.n(i);const e=flarum.core.compat["forum/components/DiscussionListItem"];var o=n.n(e);const l=flarum.core.compat["forum/components/DiscussionPage"];var u=n.n(l);const c=flarum.core.compat["forum/utils/DiscussionControls"];var d=n.n(c);const g=flarum.core.compat["common/components/Button"];var p=n.n(g);const f=flarum.core.compat["forum/components/CommentPost"];var h=n.n(f),v=n(781);const R=flarum.core.compat["common/Model"];var y=n.n(R),b=function(t){function a(){return t.apply(this,arguments)||this}return(0,v.A)(a,t),a}(y());Object.assign(b.prototype,{rating:y().attribute("rating"),createdAt:y().attribute("createdAt",y().transformDate),updatedAt:y().attribute("updatedAt",y().transformDate),user:y().hasOne("user")});const N=flarum.core.compat["common/Component"];var D=n.n(N),S=function(t){function r(){return t.apply(this,arguments)||this}(0,v.A)(r,t);var i=r.prototype;return i.oninit=function(a){t.prototype.oninit.call(this,a),this.hoveredValue=0,this.loading=!1},i.view=function(){var t=this,n=this.attrs.discussion;if(!n)return null;var r=n.ratingAverage()||0,i=n.ratingCount()||0,s=n.userRating(),e=n.canRate(),o=n.ratingDisabled(),l=n.canRateRequiresActivation(),u=!!a().session.user,c=!1!==this.attrs.interactive&&!o,d=this.attrs.size||"normal",g=this.hoveredValue>0?this.hoveredValue:2*r;return m("div",{className:"StarRating StarRating--"+d+(this.loading?" StarRating--loading":"")+(c&&e?" StarRating--interactive":"")},m("div",{className:"StarRating-starsWrap"},m("div",{className:"StarRating-stars",onmouseleave:function(){c&&e&&u&&(t.hoveredValue=0)}},this.renderStars(g,c&&e&&u,n)),m("div",{className:"StarRating-tooltip"},this.renderTooltipContent(s,i,u,l))),!1!==this.attrs.showCount&&m("span",{className:"StarRating-count",onclick:function(a){a.stopPropagation(),a.preventDefault(),i>0&&t.showRatingsModal(n)}},a().translator.trans("tryhackx-topic-rating.forum.rating_count",{count:i})))},i.renderTooltipContent=function(t,n,r,i){return r?i?m("span",null,a().translator.trans("tryhackx-topic-rating.forum.tooltip.activation_required")):t?[m("div",{className:"StarRating-tooltipLabel"},a().translator.trans("tryhackx-topic-rating.forum.tooltip.your_rating")),m("div",{className:"StarRating-tooltipStars"},this.renderTooltipStars(t))]:0===n?m("span",null,a().translator.trans("tryhackx-topic-rating.forum.tooltip.rate_first")):m("span",null,a().translator.trans("tryhackx-topic-rating.forum.tooltip.rate_this")):m("span",null,a().translator.trans("tryhackx-topic-rating.forum.tooltip.login_required"))},i.renderTooltipStars=function(t){for(var a=[],n=1;n<=5;n++)t>=2*n?a.push(m("i",{className:"fas fa-star StarRating-tooltipStar--full",key:n})):t>=2*(n-1)+1?a.push(m("i",{className:"fas fa-star-half-alt StarRating-tooltipStar--half",key:n})):a.push(m("i",{className:"far fa-star StarRating-tooltipStar--empty",key:n}));return a},i.renderStars=function(t,a,n){for(var r=this,i=[],s=function(){var s=2*(e-1)+1,o=2*e,l="StarRating-star";l+=t>=2*e?" StarRating-star--full":t>=2*(e-1)+1?" StarRating-star--half":" StarRating-star--empty",i.push(m("span",{className:l,key:e},m("span",{className:"StarRating-starHalf StarRating-starHalf--left",onmouseenter:function(){a&&(r.hoveredValue=s)},onclick:function(t){a&&(t.stopPropagation(),t.preventDefault(),r.submitRating(n,s))}}),m("span",{className:"StarRating-starHalf StarRating-starHalf--right",onmouseenter:function(){a&&(r.hoveredValue=o)},onclick:function(t){a&&(t.stopPropagation(),t.preventDefault(),r.submitRating(n,o))}}),m("i",{className:"fas fa-star StarRating-starIcon"})))},e=1;e<=5;e++)s();return i},i.submitRating=function(t,n){var r=this;this.loading||(t.userRating()!==n?(this.loading=!0,a().request({method:"POST",url:a().forum.attribute("apiUrl")+"/discussion-ratings",body:{data:{attributes:{discussionId:t.id(),rating:n}}}}).then(function(){r.loading=!1,r.refreshDiscussion(t)}).catch(function(){r.loading=!1,m.redraw()})):this.deleteRating(t))},i.deleteRating=function(t){var n=this;this.loading=!0,a().request({method:"DELETE",url:a().forum.attribute("apiUrl")+"/discussion-ratings",body:{data:{attributes:{discussionId:t.id()}}}}).then(function(){n.loading=!1,n.refreshDiscussion(t)}).catch(function(){n.loading=!1,m.redraw()})},i.refreshDiscussion=function(t){a().request({method:"GET",url:a().forum.attribute("apiUrl")+"/discussion-ratings/poll",params:{discussion_id:t.id()}}).then(function(a){t.pushData({attributes:{ratingAverage:a.ratingAverage,ratingCount:a.ratingCount,lastRatedAt:a.lastRatedAt,ratingDisabled:a.ratingDisabled,userRating:null!=a.userRating?a.userRating:null}}),m.redraw()})},i.showRatingsModal=function(t){var r=n(550).A;a().modal.show(r,{discussion:t})},r}(D());const A=flarum.core.compat["common/helpers/humanTime"];var k=n.n(A),x=function(t){function n(){return t.apply(this,arguments)||this}return(0,v.A)(n,t),n.prototype.view=function(){var t=this.attrs.discussion;if(!t)return null;var n=t.lastRatedAt();return n?m("span",{className:"LastRatedInfo"},m("span",{className:"LastRatedInfo-label"},a().translator.trans("tryhackx-topic-rating.forum.last_rated"))," ",k()(n)):null},n}(D());const T=new(function(){function t(){this.interval=null,this.discussionId=null}var n=t.prototype;return n.start=function(t){var a=this;this.stop(),this.discussionId=t.id(),this.interval=setInterval(function(){a.poll(t)},8e3)},n.stop=function(){this.interval&&(clearInterval(this.interval),this.interval=null),this.discussionId=null},n.poll=function(t){t&&t.id()===this.discussionId?a().request({method:"GET",url:a().forum.attribute("apiUrl")+"/discussion-ratings/poll",params:{discussion_id:t.id()},errorHandler:function(){}}).then(function(a){var n=t.ratingAverage(),r=t.ratingCount();a.ratingAverage===n&&a.ratingCount===r||(t.pushData({attributes:{ratingAverage:a.ratingAverage,ratingCount:a.ratingCount,lastRatedAt:a.lastRatedAt,ratingDisabled:a.ratingDisabled,userRating:void 0!==a.userRating?a.userRating:t.userRating()}}),m.redraw())}):this.stop()},t}());var M=n(924),_=function(t){function n(){return t.apply(this,arguments)||this}(0,v.A)(n,t);var r=n.prototype;return r.oninit=function(a){t.prototype.oninit.call(this,a),this.loading=!1},r.className=function(){return"ResetRatingsModal Modal--small"},r.title=function(){return a().translator.trans("tryhackx-topic-rating.forum.reset_modal.title")},r.content=function(){var t=this,n=this.attrs.discussion.ratingCount()||0;return m("div",{className:"Modal-body"},m("div",{className:"ResetRatingsModal-content"},m("div",{className:"ResetRatingsModal-icon"},m("i",{className:"fas fa-exclamation-triangle"})),m("p",{className:"ResetRatingsModal-message"},a().translator.trans("tryhackx-topic-rating.forum.reset_modal.message",{count:n})),m("div",{className:"ResetRatingsModal-buttons"},m(p(),{className:"Button",onclick:function(){return t.hide()},disabled:this.loading},a().translator.trans("tryhackx-topic-rating.forum.reset_modal.cancel")),m(p(),{className:"Button Button--danger",onclick:function(){return t.confirm()},loading:this.loading,disabled:this.loading},a().translator.trans("tryhackx-topic-rating.forum.reset_modal.confirm")))))},r.confirm=function(){var t=this,n=this.attrs.discussion;this.loading=!0,a().request({method:"POST",url:a().forum.attribute("apiUrl")+"/discussions/"+n.id()+"/reset-ratings"}).then(function(){n.pushData({attributes:{ratingCount:0,ratingAverage:0,lastRatedAt:null,userRating:null}}),t.hide(),m.redraw()}).catch(function(){t.loading=!1,m.redraw()})},n}(n.n(M)());const w=flarum.core.compat["common/models/Discussion"];var I=n.n(w);I().prototype.ratingCount=y().attribute("ratingCount"),I().prototype.ratingAverage=y().attribute("ratingAverage"),I().prototype.lastRatedAt=y().attribute("lastRatedAt",y().transformDate),I().prototype.ratingDisabled=y().attribute("ratingDisabled"),I().prototype.canRate=y().attribute("canRate"),I().prototype.canRateRequiresActivation=y().attribute("canRateRequiresActivation"),I().prototype.canToggleRating=y().attribute("canToggleRating"),I().prototype.canResetRatings=y().attribute("canResetRatings"),I().prototype.userRating=y().attribute("userRating"),a().initializers.add("tryhackx-topic-rating",function(){a().store.models["discussion-ratings"]=b,(0,r.extend)(s().prototype,"items",function(t){var a=this.attrs.discussion;a&&!a.ratingDisabled()&&t.add("rating",m(S,{discussion:a,interactive:!0,size:"normal",showCount:!0}),-5)}),(0,r.extend)(o().prototype,"infoItems",function(t){var a=this.attrs.discussion;a&&!a.ratingDisabled()&&t.add("rating",m(S,{discussion:a,interactive:!1,size:"small",showCount:!1}),15)}),(0,r.extend)(u().prototype,"show",function(t){t&&!t.ratingDisabled()&&T.start(t)});var t=u().prototype.onremove;u().prototype.onremove=function(a){T.stop(),t&&t.call(this,a)},(0,r.extend)(h().prototype,"headerItems",function(t){var a=this.attrs.post;if(a){var n=a.discussion();n&&n.lastRatedAt()&&1===a.number()&&t.add("lastRated",m(x,{discussion:n}),-10)}}),(0,r.extend)(d(),"moderationControls",function(t,n){n.canToggleRating&&n.canToggleRating()&&t.add("toggleRating",p().component({icon:n.ratingDisabled()?"fas fa-star":"far fa-star",onclick:function(){return function(t){a().request({method:"POST",url:a().forum.attribute("apiUrl")+"/discussions/"+t.id()+"/toggle-rating"}).then(function(a){var n=a.data;t.pushData({attributes:{ratingDisabled:n.attributes.ratingDisabled}}),m.redraw()})}(n)}},n.ratingDisabled()?a().translator.trans("tryhackx-topic-rating.forum.controls.enable_rating"):a().translator.trans("tryhackx-topic-rating.forum.controls.disable_rating"))),n.canResetRatings&&n.canResetRatings()&&n.ratingCount()>0&&t.add("resetRatings",p().component({icon:"fas fa-eraser",onclick:function(){return function(t){a().modal.show(_,{discussion:t})}(n)}},a().translator.trans("tryhackx-topic-rating.forum.controls.reset_ratings")))})})})(),module.exports={}})();