(()=>{var t={977(t,a,s){"use strict";s.d(a,{A:()=>c});var r=s(533),e=s.n(r);const i=flarum.reg.get("core","common/components/LoadingIndicator");var n=s.n(i),o=s(488),l=s.n(o);class c extends(e()){oninit(t){super.oninit(t),this.discussion=this.attrs.discussion,this.ratings=[],this.loading=!0,this.moreResults=!1,this.offset=0,this.limit=10,this.total=0,this.pollInterval=null,this.lastPollTime=(new Date).toISOString(),this.loadRatings(),this.startPolling()}onremove(t){super.onremove(t),this.stopPolling()}className(){return"RatingsModal Modal--small"}title(){return l().translator.trans("tryhackx-topic-rating.forum.ratings_modal.title",{count:this.total})}content(){return m("div",{className:"Modal-body"},m("div",{className:"RatingsModal-list",oncreate:this.setupScroll.bind(this)},this.ratings.map(t=>this.renderRatingItem(t)),this.loading&&m(n(),null),!this.loading&&0===this.ratings.length&&m("div",{className:"RatingsModal-empty"},l().translator.trans("tryhackx-topic-rating.forum.ratings_modal.empty"))))}parseDate(t){if(!t)return null;const a=new Date(t);return isNaN(a.getTime())||a.getFullYear()<=1970?null:a}formatDateTime(t){const a=t=>String(t).padStart(2,"0");return a(t.getDate())+"."+a(t.getMonth()+1)+"."+t.getFullYear()+" "+a(t.getHours())+":"+a(t.getMinutes())}renderRatingItem(t){const a=t.user,s=this.renderStarsDisplay(t.rating),r=this.parseDate(t.createdAt),e=this.parseDate(t.updatedAt),i=e&&r&&e.getTime()-r.getTime()>1e3,n=i?e:r,o=a?l().route("user",{username:a.slug||a.username}):null;return m("div",{className:"RatingsModal-item",key:t.id},m("div",{className:"RatingsModal-item-avatar"},a?m("a",{href:o},m("span",{className:"Avatar",style:a.avatarUrl?{"background-image":"url("+a.avatarUrl+")"}:{"background-color":a.color||"#888"}},a.avatarUrl?"":(a.displayName||a.username||"?").charAt(0).toUpperCase())):m("span",{className:"Avatar"},"?")),m("div",{className:"RatingsModal-item-info"},m("div",{className:"RatingsModal-item-top"},a?m("a",{href:o,className:"RatingsModal-item-username"},a.displayName||a.username):m("span",{className:"RatingsModal-item-username"},l().translator.trans("tryhackx-topic-rating.forum.ratings_modal.deleted_user")),n&&m("span",{className:"RatingsModal-item-date",title:this.formatDateTime(n)},i&&m("span",{className:"RatingsModal-item-date-prefix"},l().translator.trans("tryhackx-topic-rating.forum.ratings_modal.updated_prefix")),this.formatDateTime(n))),m("div",{className:"RatingsModal-item-stars"},s,m("span",{className:"RatingsModal-item-value"},(t.rating/2).toFixed(1)))))}renderStarsDisplay(t){const a=[];for(let s=1;s<=5;s++){let r="StarDisplay";r+=t>=2*s?" StarDisplay--full":t>=2*(s-1)+1?" StarDisplay--half":" StarDisplay--empty",a.push(m("i",{className:"fas fa-star "+r,key:s}))}return m("span",{className:"StarDisplay-container"},a)}loadRatings(){this.loading=!0;const t=this.discussion.id(),a=l().forum.attribute("apiUrl")+"/discussion-ratings?discussion_id="+t+"&page[offset]="+this.offset+"&page[limit]="+this.limit;fetch(a,{method:"GET",headers:{Accept:"application/json","X-CSRF-Token":l().session.csrfToken},credentials:"same-origin"}).then(t=>{if(!t.ok)throw new Error("HTTP "+t.status);return t.json()}).then(t=>{const a=this.parseRatings(t);this.ratings=0===this.offset?a:[...this.ratings,...a],this.total=t.meta?t.meta.total:this.ratings.length,this.moreResults=a.length>=this.limit,this.loading=!1,m.redraw()}).catch(t=>{console.error("RatingsModal load error:",t),this.loading=!1,m.redraw()})}parseRatings(t){const a=t.data||[],s=t.included||[],r={};return s.forEach(t=>{"users"===t.type&&(r[t.id]={id:t.id,slug:t.attributes.slug||t.attributes.username,username:t.attributes.username,displayName:t.attributes.displayName||t.attributes.username,avatarUrl:t.attributes.avatarUrl,color:t.attributes.color})}),a.map(t=>{const a=t.relationships&&t.relationships.user?t.relationships.user.data.id:null;return{id:t.id,rating:t.attributes.rating,createdAt:t.attributes.createdAt,updatedAt:t.attributes.updatedAt,user:a&&r[a]||null}})}setupScroll(t){const a=t.dom;a.addEventListener("scroll",()=>{!this.loading&&this.moreResults&&a.scrollTop+a.clientHeight>=a.scrollHeight-50&&(this.offset+=this.limit,this.loadRatings())})}startPolling(){this.pollInterval=setInterval(()=>{this.pollForNewRatings()},5e3)}stopPolling(){this.pollInterval&&(clearInterval(this.pollInterval),this.pollInterval=null)}pollForNewRatings(){const t=l().forum.attribute("apiUrl")+"/discussion-ratings/poll?discussion_id="+this.discussion.id()+"&since="+encodeURIComponent(this.lastPollTime);fetch(t,{method:"GET",headers:{Accept:"application/json","X-CSRF-Token":l().session.csrfToken},credentials:"same-origin"}).then(t=>t.json()).then(t=>{t.hasNewRatings&&(this.lastPollTime=(new Date).toISOString(),this.total=t.ratingCount,this.offset=0,this.loadRatings())})}}flarum.reg.add("tryhackx-topic-rating","forum/components/RatingsModal",c)},533(t){"use strict";t.exports=flarum.reg.get("core","common/components/Modal")},488(t){"use strict";t.exports=flarum.reg.get("core","forum/app")}},a={};function s(r){flarum.reg._webpack_runtimes["tryhackx-topic-rating"]||=s;var e=a[r];if(void 0!==e)return e.exports;var i=a[r]={exports:{}};return t[r](i,i.exports,s),i.exports}s.n=t=>{var a=t&&t.__esModule?()=>t.default:()=>t;return s.d(a,{a}),a},s.d=(t,a)=>{for(var r in a)s.o(a,r)&&!s.o(t,r)&&Object.defineProperty(t,r,{enumerable:!0,get:a[r]})},s.o=(t,a)=>Object.prototype.hasOwnProperty.call(t,a),(()=>{"use strict";var t=s(488),a=s.n(t);const r=flarum.reg.get("core","common/extend"),e=flarum.reg.get("core","forum/components/DiscussionHero");var i=s.n(e);const n=flarum.reg.get("core","forum/components/DiscussionListItem");var o=s.n(n);const l=flarum.reg.get("core","forum/components/DiscussionPage");var c=s.n(l);const u=flarum.reg.get("core","forum/utils/DiscussionControls");var d=s.n(u);const g=flarum.reg.get("core","common/components/Button");var p=s.n(g);const h=flarum.reg.get("core","forum/components/CommentPost");var f=s.n(h);const R=flarum.reg.get("core","common/Model");var v=s.n(R);class y extends(v()){}Object.assign(y.prototype,{rating:v().attribute("rating"),createdAt:v().attribute("createdAt",v().transformDate),updatedAt:v().attribute("updatedAt",v().transformDate),user:v().hasOne("user")}),flarum.reg.add("tryhackx-topic-rating","common/models/Rating",y);const b=flarum.reg.get("core","common/Component");var N=s.n(b);class S extends(N()){oninit(t){super.oninit(t),this.hoveredValue=0,this.loading=!1}view(){const t=this.attrs.discussion;if(!t)return null;const s=t.ratingAverage()||0,r=t.ratingCount()||0,e=t.userRating(),i=t.canRate(),n=t.ratingDisabled(),o=t.canRateRequiresActivation(),l=!!a().session.user,c=!1!==this.attrs.interactive&&!n,u=this.attrs.size||"normal",d=this.hoveredValue>0?this.hoveredValue:2*s;return m("div",{className:"StarRating StarRating--"+u+(this.loading?" StarRating--loading":"")+(c&&i?" StarRating--interactive":"")},m("div",{className:"StarRating-starsWrap"},m("div",{className:"StarRating-stars",onmouseleave:()=>{c&&i&&l&&(this.hoveredValue=0)}},this.renderStars(d,c&&i&&l,t)),m("div",{className:"StarRating-tooltip"},this.renderTooltipContent(e,r,l,o))),!1!==this.attrs.showCount&&m("span",{className:"StarRating-count",onclick:a=>{a.stopPropagation(),a.preventDefault(),r>0&&this.showRatingsModal(t)}},a().translator.trans("tryhackx-topic-rating.forum.rating_count",{count:r})))}renderTooltipContent(t,s,r,e){return r?e?m("span",null,a().translator.trans("tryhackx-topic-rating.forum.tooltip.activation_required")):t?[m("div",{className:"StarRating-tooltipLabel"},a().translator.trans("tryhackx-topic-rating.forum.tooltip.your_rating")),m("div",{className:"StarRating-tooltipStars"},this.renderTooltipStars(t))]:0===s?m("span",null,a().translator.trans("tryhackx-topic-rating.forum.tooltip.rate_first")):m("span",null,a().translator.trans("tryhackx-topic-rating.forum.tooltip.rate_this")):m("span",null,a().translator.trans("tryhackx-topic-rating.forum.tooltip.login_required"))}renderTooltipStars(t){const a=[];for(let s=1;s<=5;s++)t>=2*s?a.push(m("i",{className:"fas fa-star StarRating-tooltipStar--full",key:s})):t>=2*(s-1)+1?a.push(m("i",{className:"fas fa-star-half-alt StarRating-tooltipStar--half",key:s})):a.push(m("i",{className:"far fa-star StarRating-tooltipStar--empty",key:s}));return a}renderStars(t,a,s){const r=[];for(let e=1;e<=5;e++){const i=2*(e-1)+1,n=2*e;let o="StarRating-star";o+=t>=2*e?" StarRating-star--full":t>=2*(e-1)+1?" StarRating-star--half":" StarRating-star--empty",r.push(m("span",{className:o,key:e},m("span",{className:"StarRating-starHalf StarRating-starHalf--left",onmouseenter:()=>{a&&(this.hoveredValue=i)},onclick:t=>{a&&(t.stopPropagation(),t.preventDefault(),this.submitRating(s,i))}}),m("span",{className:"StarRating-starHalf StarRating-starHalf--right",onmouseenter:()=>{a&&(this.hoveredValue=n)},onclick:t=>{a&&(t.stopPropagation(),t.preventDefault(),this.submitRating(s,n))}}),m("i",{className:"fas fa-star StarRating-starIcon"})))}return r}submitRating(t,s){this.loading||(t.userRating()!==s?(this.loading=!0,a().request({method:"POST",url:a().forum.attribute("apiUrl")+"/discussion-ratings",body:{data:{attributes:{discussionId:t.id(),rating:s}}}}).then(()=>{this.loading=!1,this.refreshDiscussion(t)}).catch(()=>{this.loading=!1,m.redraw()})):this.deleteRating(t))}deleteRating(t){this.loading=!0,a().request({method:"DELETE",url:a().forum.attribute("apiUrl")+"/discussion-ratings",body:{data:{attributes:{discussionId:t.id()}}}}).then(()=>{this.loading=!1,this.refreshDiscussion(t)}).catch(()=>{this.loading=!1,m.redraw()})}refreshDiscussion(t){a().request({method:"GET",url:a().forum.attribute("apiUrl")+"/discussion-ratings/poll",params:{discussion_id:t.id()}}).then(a=>{t.pushData({attributes:{ratingAverage:a.ratingAverage,ratingCount:a.ratingCount,lastRatedAt:a.lastRatedAt,ratingDisabled:a.ratingDisabled,userRating:null!=a.userRating?a.userRating:null}}),m.redraw()})}showRatingsModal(t){const r=s(977).A;a().modal.show(r,{discussion:t})}}flarum.reg.add("tryhackx-topic-rating","forum/components/StarRating",S);const D=flarum.reg.get("core","common/helpers/humanTime");var x=s.n(D);class k extends(N()){view(){const t=this.attrs.discussion;if(!t)return null;const s=t.lastRatedAt();return s?m("span",{className:"LastRatedInfo"},m("span",{className:"LastRatedInfo-label"},a().translator.trans("tryhackx-topic-rating.forum.last_rated"))," ",x()(s)):null}}flarum.reg.add("tryhackx-topic-rating","forum/components/LastRatedInfo",k);const A=new class{constructor(){this.interval=null,this.discussionId=null}start(t){this.stop(),this.discussionId=t.id(),this.interval=setInterval(()=>{this.poll(t)},8e3)}stop(){this.interval&&(clearInterval(this.interval),this.interval=null),this.discussionId=null}poll(t){t&&t.id()===this.discussionId?a().request({method:"GET",url:a().forum.attribute("apiUrl")+"/discussion-ratings/poll",params:{discussion_id:t.id()},errorHandler:()=>{}}).then(a=>{const s=t.ratingAverage(),r=t.ratingCount();a.ratingAverage===s&&a.ratingCount===r||(t.pushData({attributes:{ratingAverage:a.ratingAverage,ratingCount:a.ratingCount,lastRatedAt:a.lastRatedAt,ratingDisabled:a.ratingDisabled,userRating:void 0!==a.userRating?a.userRating:t.userRating()}}),m.redraw())}):this.stop()}},T=A;flarum.reg.add("tryhackx-topic-rating","forum/components/RatingPolling",A);var M=s(533),w=s.n(M);class I extends(w()){oninit(t){super.oninit(t),this.loading=!1}className(){return"ResetRatingsModal Modal--small"}title(){return a().translator.trans("tryhackx-topic-rating.forum.reset_modal.title")}content(){const t=this.attrs.discussion.ratingCount()||0;return m("div",{className:"Modal-body"},m("div",{className:"ResetRatingsModal-content"},m("div",{className:"ResetRatingsModal-icon"},m("i",{className:"fas fa-exclamation-triangle"})),m("p",{className:"ResetRatingsModal-message"},a().translator.trans("tryhackx-topic-rating.forum.reset_modal.message",{count:t})),m("div",{className:"ResetRatingsModal-buttons"},m(p(),{className:"Button",onclick:()=>this.hide(),disabled:this.loading},a().translator.trans("tryhackx-topic-rating.forum.reset_modal.cancel")),m(p(),{className:"Button Button--danger",onclick:()=>this.confirm(),loading:this.loading,disabled:this.loading},a().translator.trans("tryhackx-topic-rating.forum.reset_modal.confirm")))))}confirm(){const t=this.attrs.discussion;this.loading=!0,a().request({method:"POST",url:a().forum.attribute("apiUrl")+"/discussions/"+t.id()+"/reset-ratings"}).then(()=>{t.pushData({attributes:{ratingCount:0,ratingAverage:0,lastRatedAt:null,userRating:null}}),this.hide(),m.redraw()}).catch(()=>{this.loading=!1,m.redraw()})}}flarum.reg.add("tryhackx-topic-rating","forum/components/ResetRatingsModal",I);const _=flarum.reg.get("core","common/models/Discussion");var C=s.n(_);C().prototype.ratingCount=v().attribute("ratingCount"),C().prototype.ratingAverage=v().attribute("ratingAverage"),C().prototype.lastRatedAt=v().attribute("lastRatedAt",v().transformDate),C().prototype.ratingDisabled=v().attribute("ratingDisabled"),C().prototype.canRate=v().attribute("canRate"),C().prototype.canRateRequiresActivation=v().attribute("canRateRequiresActivation"),C().prototype.canToggleRating=v().attribute("canToggleRating"),C().prototype.canResetRatings=v().attribute("canResetRatings"),C().prototype.userRating=v().attribute("userRating"),a().initializers.add("tryhackx-topic-rating",()=>{a().store.models["discussion-ratings"]=y,(0,r.extend)(i().prototype,"items",function(t){const a=this.attrs.discussion;a&&!a.ratingDisabled()&&t.add("rating",m(S,{discussion:a,interactive:!0,size:"normal",showCount:!0}),-5)}),(0,r.extend)(o().prototype,"infoItems",function(t){const a=this.attrs.discussion;a&&!a.ratingDisabled()&&t.add("rating",m(S,{discussion:a,interactive:!1,size:"small",showCount:!1}),15)}),(0,r.extend)(c().prototype,"show",function(t){t&&!t.ratingDisabled()&&T.start(t)});const t=c().prototype.onremove;c().prototype.onremove=function(a){T.stop(),t&&t.call(this,a)},(0,r.extend)(f().prototype,"headerItems",function(t){const a=this.attrs.post;if(!a)return;const s=a.discussion();s&&s.lastRatedAt()&&1===a.number()&&t.add("lastRated",m(k,{discussion:s}),-10)}),(0,r.extend)(d(),"moderationControls",function(t,s){s.canToggleRating&&s.canToggleRating()&&t.add("toggleRating",p().component({icon:s.ratingDisabled()?"fas fa-star":"far fa-star",onclick:()=>function(t){a().request({method:"POST",url:a().forum.attribute("apiUrl")+"/discussions/"+t.id()+"/toggle-rating"}).then(a=>{t.pushData({attributes:{ratingDisabled:a.ratingDisabled}}),m.redraw()})}(s)},s.ratingDisabled()?a().translator.trans("tryhackx-topic-rating.forum.controls.enable_rating"):a().translator.trans("tryhackx-topic-rating.forum.controls.disable_rating"))),s.canResetRatings&&s.canResetRatings()&&s.ratingCount()>0&&t.add("resetRatings",p().component({icon:"fas fa-eraser",onclick:()=>function(t){a().modal.show(I,{discussion:t})}(s)},a().translator.trans("tryhackx-topic-rating.forum.controls.reset_ratings")))})})})(),module.exports={}})();